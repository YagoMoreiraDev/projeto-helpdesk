<div class="chamados-wrapper mx-auto">
    <div class="table-responsive rounded-4 shadow-sm overflow-hidden">
        <table class="table table-hover align-middle m-0">
            <thead class="table-dark sticky-top">
                <tr>
                    <th class="fit">#</th>
                    <th>Solicitante</th>
                    <th>Tipo</th>
                    <th>Descrição</th>
                    <th class="nowrap">Data/Hora</th>
                    <th>Técnico</th>
                    <th class="nowrap">Status</th>
                    <th class="fit">Ações</th>
                </tr>
            </thead>

            <tbody>
                <tr *ngFor="let c of chamados; let i = index" class="row-hover">
                    <td class="text-muted fit">{{ i + 1 }}</td>

                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="avatar">{{ c.solicitante[0] || '?' }}</div>
                            <div class="fw-semibold">{{ c.solicitante }}</div>
                        </div>
                    </td>

                    <td class="text-body-emphasis">{{ c.tipo }}</td>

                    <td class="desc">
                        <span class="text-secondary">{{ c.descricao }}</span>
                    </td>

                    <td class="nowrap">
                        {{ c.dataHora | date:'dd/MM/yy HH:mm' }}
                    </td>

                    <td class="text-body-emphasis">
                        <span *ngIf="c.tecnico; else semTec">{{ c.tecnico }}</span>
                        <ng-template #semTec><span class="text-muted">—</span></ng-template>
                    </td>

                    <td class="nowrap">
                        <span class="badge me-2" [ngClass]="badgeClasses(c.status)">
                            {{ badgeLabel(c.status) }}
                        </span>

                        <!-- spinner quando em andamento -->
                        <div *ngIf="c.status === 'EM_ANDAMENTO'"
                            class="spinner-border spinner-border-sm text-warning align-text-bottom" role="status"
                            aria-hidden="true"></div>
                    </td>

                    <td class="fit">
                        <div class="btn-group btn-group-sm" role="group" aria-label="Ações">

                            <!-- USUARIO_COMUM: só excluir -->
                            <button *ngIf="canExcluir(c)" type="button" class="btn btn-outline-danger"
                                (click)="onExcluir(c)" title="Excluir">
                                <i class="bi bi-trash3"></i>
                            </button>

                            <!-- TECNICO: atribuir pra mim (se em aberto e sem técnico) -->
                            <button *ngIf="canAtribuirPraMim(c)" type="button" class="btn btn-outline-secondary"
                                (click)="onAtribuirPraMim(c)" title="Assumir este chamado">
                                <i class="bi bi-person-check"></i>
                            </button>

                            <!-- TECNICO: alterar status -->
                            <button *ngIf="canMarcarAndamento(c)" type="button" class="btn btn-outline-primary"
                                (click)="onSetStatus(c, 'EM_ANDAMENTO')" title="Marcar como em andamento">
                                <i class="bi bi-play-fill"></i>
                            </button>

                            <button *ngIf="canMarcarConcluido(c)" type="button" class="btn btn-outline-success"
                                (click)="onSetStatus(c, 'CONCLUIDO')" title="Marcar como concluído">
                                <i class="bi bi-check2-circle"></i>
                            </button>

                            <!-- TECNICO: comentar -->
                            <button *ngIf="canComentar(c)" type="button" class="btn btn-outline-dark"
                                (click)="onComentar(c)" title="Adicionar comentário">
                                <i class="bi bi-chat-text"></i>
                            </button>

                            <div *ngIf="role==='ADMIN'" class="btn-group btn-group-sm dropstart">
                                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"
                                    title="Designar técnico">
                                    <i class="bi bi-person-plus"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end p-0 overflow-auto"
                                    style="max-height: 240px;">
                                    <li *ngFor="let t of tecnicos"><!-- tecnicos: [{id, nome}] -->
                                        <button type="button" class="dropdown-item" (click)="onDesignar(c, t.id)">
                                            {{ t.nome }}
                                        </button>
                                    </li>
                                </ul>
                            </div>

                            <!-- ADMIN: setar status livremente -->
                            <button *ngIf="role==='ADMIN'" class="btn btn-outline-primary btn-sm"
                                (click)="onSetStatus(c, 'EM_ANDAMENTO')">
                                <i class="bi bi-play-fill"></i>
                            </button>
                            <button *ngIf="role==='ADMIN'" class="btn btn-outline-success btn-sm"
                                (click)="onSetStatus(c, 'CONCLUIDO')">
                                <i class="bi bi-check2-circle"></i>
                            </button>
                            <button *ngIf="role==='ADMIN'" class="btn btn-outline-secondary btn-sm"
                                (click)="onSetStatus(c, 'EM_ABERTO')">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>

                            <!-- ADMIN: cancelar -->
                            <button *ngIf="role==='ADMIN'" class="btn btn-outline-danger btn-sm"
                                (click)="onCancelar(c)">
                                <i class="bi bi-x-octagon"></i>
                            </button>
                        </div>
                    </td>
                </tr>

                <tr *ngIf="!chamados?.length">
                    <td colspan="8" class="text-center py-5 text-muted">
                        Nenhum chamado encontrado.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>